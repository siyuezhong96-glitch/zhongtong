<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦å‹æŒ‡æ ‡ç¼ºå£ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #ffd6e8 50%, #ffb3d9 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease-out;
        }

        h1 {
            color: #ff69b4;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(255, 105, 180, 0.3);
        }

        .subtitle {
            color: #ff1493;
            font-size: 1.1em;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.2);
            animation: fadeInUp 0.6s ease-out;
        }

        .section-title {
            font-size: 1.8em;
            color: #ff1493;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            overflow-x: auto;
        }

        .data-table th {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            padding: 12px 10px;
            font-weight: 600;
            text-align: center;
            border: 2px solid #ff1493;
            font-size: 0.95em;
        }

        .data-table th:first-child {
            border-top-left-radius: 12px;
        }

        .data-table th:last-child {
            border-top-right-radius: 12px;
        }

        .data-table td {
            padding: 8px;
            border: 2px solid #ffc0cb;
            background: #fff5f8;
            text-align: center;
        }

        .data-table td.vehicle-label {
            background: linear-gradient(135deg, #fff5f8 0%, #ffe4f0 100%);
            font-weight: 600;
            color: #ff1493;
            font-size: 1.05em;
        }

        .data-table input, .data-table select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ffc0cb;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background: white;
        }

        .data-table input:focus, .data-table select:focus {
            outline: none;
            border-color: #ff69b4;
            box-shadow: 0 0 8px rgba(255, 105, 180, 0.3);
        }

        .data-table input[type="number"] {
            text-align: right;
        }

        .data-table .total-cell {
            background: linear-gradient(135deg, #ffe4f0 0%, #ffd6e8 100%);
            font-weight: 600;
            color: #ff1493;
            font-size: 1.05em;
        }

        .add-button {
            display: inline-block;
            margin: 15px 0;
            padding: 10px 25px;
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(255, 105, 180, 0.3);
        }

        .add-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 105, 180, 0.4);
        }

        .delete-button {
            padding: 4px 10px;
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-button:hover {
            background: #ff1493;
        }

        .summary-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.2);
            animation: fadeInUp 0.8s ease-out;
        }

        .summary-title {
            font-size: 1.8em;
            color: #ff1493;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #fff5f8 0%, #ffe4f0 100%);
            border-radius: 15px;
            border: 2px solid #ffc0cb;
        }

        .summary-label {
            color: #ff69b4;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .summary-value {
            color: #ff1493;
            font-size: 1.6em;
            font-weight: bold;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .section {
                padding: 15px;
            }

            .data-table th,
            .data-table td {
                padding: 6px 4px;
                font-size: 0.85em;
            }

            .data-table input, .data-table select {
                padding: 6px;
                font-size: 0.85em;
            }
        }

        .table-wrapper {
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš— è½¦å‹æŒ‡æ ‡ç¼ºå£ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="subtitle">è¾“å…¥å„è½¦å‹2026å¹´å­£åº¦æŒ‡æ ‡ç¼ºå£ï¼Œç³»ç»Ÿè‡ªåŠ¨ä¿å­˜</p>
        </header>

        <!-- æ¨¡å—1: å½“å‰æŒ‡æ ‡ç¼ºå£ -->
        <div class="section">
            <h2 class="section-title">1. å½“å‰æŒ‡æ ‡ç¼ºå£</h2>
            <div style="margin-bottom: 15px;">
                <button class="add-button" onclick="downloadGapTemplate()">ğŸ“¥ ä¸‹è½½ç¼ºå£æ¨¡æ¿</button>
                <button class="add-button" onclick="document.getElementById('gapFileInput').click()">ğŸ“¤ å¯¼å…¥ç¼ºå£æ•°æ®</button>
                <input type="file" id="gapFileInput" accept=".csv,.txt" style="display:none;" onchange="importGapData(event)">
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="gapTable">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </table>
            </div>
        </div>

        <!-- æ¨¡å—2: è¿”åˆ©æƒ…å†µ -->
        <div class="section">
            <h2 class="section-title">2. è¿”åˆ©æƒ…å†µ</h2>
            <div style="margin-bottom: 15px;">
                <button class="add-button" onclick="addRebateRow()">â• æ·»åŠ è¿”åˆ©è®°å½•</button>
                <button class="add-button" onclick="downloadRebateTemplate()">ğŸ“¥ ä¸‹è½½è¿”åˆ©æ¨¡æ¿</button>
                <button class="add-button" onclick="document.getElementById('rebateFileInput').click()">ğŸ“¤ å¯¼å…¥è¿”åˆ©æ•°æ®</button>
                <input type="file" id="rebateFileInput" accept=".csv,.txt" style="display:none;" onchange="importRebateData(event)">
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="rebateTable">
                    <thead>
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 100px;">é‡‡è´­ç»ç†</th>
                            <th style="width: 120px;">è¿”åˆ©ç±»å‹</th>
                            <th style="width: 120px;">è¿”åˆ©é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                            <th style="width: 160px;">ä¾›åº”å•†åç§°</th>
                            <th style="width: 130px;">ä¾›è´§è½¦å‹</th>
                            <th style="width: 130px;">æ¨èè½åœ°è½¦å‹</th>
                            <th style="width: 130px;">æ¨èè½åœ°æ—¶é—´</th>
                            <th style="width: 120px;">æœ€æ—©ç­¾ç½²æ—¶é—´</th>
                            <th style="width: 120px;">æœ€è¿Ÿç­¾ç½²æ—¶é—´</th>
                            <th style="width: 180px;">å¤‡æ³¨</th>
                            <th style="width: 70px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rebateTableBody">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ¨¡å—3: è¿”åˆ©åˆ†é…ç»“æœ -->
        <div class="section">
            <h2 class="section-title">3. è¿”åˆ©åˆ†é…ç»“æœ</h2>
            <button class="add-button" onclick="renderAllocationTable()">ğŸ”„ æ‰§è¡Œæ™ºèƒ½åˆ†é…</button>
            <div class="table-wrapper">
                <table class="data-table" id="allocationTable">
                    <thead>
                        <tr>
                            <th style="width: 120px;">è½¦å‹</th>
                            <th>2026 Q1</th>
                            <th>2026 Q2</th>
                            <th>2026 Q3</th>
                            <th>2026 Q4</th>
                            <th>åˆè®¡</th>
                        </tr>
                    </thead>
                    <tbody id="allocationTableBody">
                        <tr><td colspan="6" style="text-align:center;color:#ff69b4;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ‰§è¡Œæ™ºèƒ½åˆ†é…</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #fff5f8; border-radius: 10px; border: 2px solid #ffc0cb;">
                <h3 style="color: #ff1493; margin-bottom: 10px;">ğŸ“Œ åˆ†é…è§„åˆ™è¯´æ˜</h3>
                <ul style="color: #ff69b4; line-height: 1.8;">
                    <li>ç³»ç»Ÿæ ¹æ®è¿”åˆ©è®°å½•ä¸­çš„"ä¾›è´§è½¦å‹"å’Œ"ç­¾ç½²æ—¶é—´èŒƒå›´"è‡ªåŠ¨åŒ¹é…å¯¹åº”çš„ç¼ºå£</li>
                    <li>è¿”åˆ©é‡‘é¢æŒ‰ç¼ºå£æ¯”ä¾‹æ™ºèƒ½åˆ†é…åˆ°åŒ¹é…çš„è½¦å‹-å­£åº¦ç»„åˆ</li>
                    <li>é¢œè‰²è¯´æ˜ï¼š<span style="background: #d4edda; padding: 2px 8px; border-radius: 4px;">ç»¿è‰²=å®Œå…¨å¡«å……</span> <span style="background: #fff3cd; padding: 2px 8px; border-radius: 4px;">é»„è‰²=éƒ¨åˆ†å¡«å……</span> <span style="background: #ffe4e1; padding: 2px 8px; border-radius: 4px;">æµ…çº¢=å°‘é‡å¡«å……</span></li>
                    <li>é¼ æ ‡æ‚¬åœå¯æŸ¥çœ‹è¯¥ç¼ºå£çš„è¿”åˆ©æ¥æºä¾›åº”å•†</li>
                </ul>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ±‡æ€» -->
        <div class="summary-section">
            <h2 class="summary-title">ğŸ“Š æŒ‡æ ‡ç¼ºå£ä¸è¿”åˆ©æ±‡æ€»</h2>
            <div class="summary-content">
                <div class="summary-item">
                    <div class="summary-label">æ€»æŒ‡æ ‡ç¼ºå£</div>
                    <div class="summary-value" id="totalGap">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æ€»è¿”åˆ©é‡‘é¢</div>
                    <div class="summary-value" id="totalRebate">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">å‰©ä½™ç¼ºå£</div>
                    <div class="summary-value" id="remainingGap">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">å¡«å……ç‡</div>
                    <div class="summary-value" id="fillRate">0%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è½¦å‹é…ç½®
        const vehicles = [
            { code: 'X01', name: 'X01', icon: 'ğŸš™' },
            { code: 'X02', name: 'X02', icon: 'ğŸš™' },
            { code: 'X03', name: 'X03', icon: 'ğŸš™' },
            { code: 'X04', name: 'X04', icon: 'ğŸš™' },
            { code: 'W01', name: 'W01', icon: 'ğŸš' },
            { code: 'W02', name: 'W02', icon: 'ğŸš™' },
            { code: 'W04', name: 'W04', icon: 'ğŸš™' }
        ];

        const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];

        // è¿”åˆ©ç±»å‹é€‰é¡¹
        const rebateTypes = [
            'ä¸€èˆ¬ä¸€æ¬¡æ€§è¿”åˆ©',
            'é˜¶æ¢¯è¿”åˆ©',
            'å¹´åº¦è¿”åˆ©',
            'å…¶ä»–'
        ];

        // æ ¼å¼åŒ–æ•°å­—
        function formatCurrency(value) {
            if (!value || value === '') return '0.00';
            const num = parseFloat(value);
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // ===== æ¨¡å—1: æŒ‡æ ‡ç¼ºå£è¡¨æ ¼ =====
        function generateGapTable() {
            const table = document.getElementById('gapTable');
            let html = '<thead><tr><th style="width: 120px;">è½¦å‹</th>';

            // è¡¨å¤´ï¼šå­£åº¦åˆ—
            quarters.forEach(q => {
                html += `<th>2026 ${q}</th>`;
            });
            html += '<th>åˆè®¡</th></tr></thead><tbody>';

            // æ•°æ®è¡Œï¼šæ¯ä¸ªè½¦å‹ä¸€è¡Œ
            vehicles.forEach(vehicle => {
                html += `<tr><td class="vehicle-label">${vehicle.icon} ${vehicle.name}</td>`;
                quarters.forEach(q => {
                    html += `<td>
                        <input type="number"
                               data-vehicle="${vehicle.code}"
                               data-quarter="${q}"
                               placeholder="0.00"
                               step="0.01">
                    </td>`;
                });
                html += `<td class="total-cell" id="${vehicle.code}-total">Â¥0.00</td></tr>`;
            });

            html += '</tbody>';
            table.innerHTML = html;

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.querySelectorAll('#gapTable input').forEach(input => {
                input.addEventListener('input', function() {
                    saveGapData(this.dataset.vehicle, this.dataset.quarter, this.value);
                    updateVehicleTotal(this.dataset.vehicle);
                    updateSummary();
                });

                input.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = parseFloat(this.value).toFixed(2);
                    }
                });
            });
        }

        // ä¿å­˜æŒ‡æ ‡ç¼ºå£æ•°æ®
        function saveGapData(vehicle, quarter, value) {
            const key = `gap_${vehicle}_${quarter}`;
            localStorage.setItem(key, value);
        }

        // åŠ è½½æŒ‡æ ‡ç¼ºå£æ•°æ®
        function loadGapData() {
            vehicles.forEach(vehicle => {
                quarters.forEach(quarter => {
                    const key = `gap_${vehicle.code}_${quarter}`;
                    const value = localStorage.getItem(key);
                    if (value) {
                        const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                        if (input) {
                            input.value = value;
                        }
                    }
                });
                updateVehicleTotal(vehicle.code);
            });
        }

        // æ›´æ–°å•ä¸ªè½¦å‹åˆè®¡
        function updateVehicleTotal(vehicleCode) {
            let total = 0;
            quarters.forEach(quarter => {
                const input = document.querySelector(`#gapTable [data-vehicle="${vehicleCode}"][data-quarter="${quarter}"]`);
                if (input && input.value) {
                    total += parseFloat(input.value);
                }
            });
            const totalElement = document.getElementById(`${vehicleCode}-total`);
            if (totalElement) {
                totalElement.textContent = `Â¥${formatCurrency(total)}`;
            }
        }

        // ä¸‹è½½æŒ‡æ ‡ç¼ºå£æ¨¡æ¿
        function downloadGapTemplate() {
            // åˆ›å»ºCSVå†…å®¹
            let csv = '\uFEFFè½¦å‹,2026 Q1,2026 Q2,2026 Q3,2026 Q4\n'; // \uFEFFæ˜¯BOMï¼Œè®©Excelæ­£ç¡®è¯†åˆ«UTF-8
            vehicles.forEach(vehicle => {
                csv += `${vehicle.name},0,0,0,0\n`;
            });

            // åˆ›å»ºä¸‹è½½
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'æŒ‡æ ‡ç¼ºå£æ¨¡æ¿.csv';
            link.click();
        }

        // è‡ªåŠ¨æ£€æµ‹CSVåˆ†éš”ç¬¦
        function detectDelimiter(line) {
            const delimiters = [',', '\t', ';', '|'];
            let bestDelimiter = ',';
            let maxCount = 0;

            for (const delimiter of delimiters) {
                const count = (line.match(new RegExp('\\' + delimiter, 'g')) || []).length;
                if (count > maxCount) {
                    maxCount = count;
                    bestDelimiter = delimiter;
                }
            }

            return bestDelimiter;
        }

        // å¯¼å…¥æŒ‡æ ‡ç¼ºå£æ•°æ®
        function importGapData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    console.log('æ–‡ä»¶å†…å®¹:', content.substring(0, 200)); // è°ƒè¯•ä¿¡æ¯

                    const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                    console.log('æ€»è¡Œæ•°:', lines.length); // è°ƒè¯•ä¿¡æ¯

                    if (lines.length === 0) {
                        alert('æ–‡ä»¶ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼');
                        return;
                    }

                    // è·³è¿‡è¡¨å¤´
                    let startIndex = 0;
                    if (lines[0].includes('è½¦å‹') || lines[0].includes('Q1')) {
                        startIndex = 1;
                        console.log('æ£€æµ‹åˆ°è¡¨å¤´:', lines[0]); // è°ƒè¯•ä¿¡æ¯
                    }

                    // è‡ªåŠ¨æ£€æµ‹åˆ†éš”ç¬¦
                    const sampleLine = lines[startIndex] || lines[0];
                    const delimiter = detectDelimiter(sampleLine);
                    console.log('æ£€æµ‹åˆ°åˆ†éš”ç¬¦:', delimiter === '\t' ? 'Tab' : delimiter); // è°ƒè¯•ä¿¡æ¯

                    let importCount = 0;
                    let errorLines = [];

                    for (let i = startIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        // ä½¿ç”¨æ£€æµ‹åˆ°çš„åˆ†éš”ç¬¦è§£æCSVè¡Œ
                        const parts = line.split(delimiter).map(p => p.trim());
                        console.log(`ç¬¬${i+1}è¡Œæ•°æ®:`, parts); // è°ƒè¯•ä¿¡æ¯

                        if (parts.length < 1) {
                            errorLines.push(`ç¬¬${i+1}è¡Œï¼šæ²¡æœ‰è½¦å‹ä¿¡æ¯`);
                            continue;
                        }

                        const vehicleCode = parts[0];
                        const vehicle = vehicles.find(v => v.code === vehicleCode || v.name === vehicleCode);

                        if (!vehicle) {
                            errorLines.push(`ç¬¬${i+1}è¡Œï¼šè½¦å‹"${vehicleCode}"ä¸å­˜åœ¨ï¼ˆæœ‰æ•ˆè½¦å‹ï¼šX01,X02,X03,X04,W01,W02,W04ï¼‰`);
                            continue;
                        }

                        // å¯¼å…¥4ä¸ªå­£åº¦çš„æ•°æ®ï¼Œç¼ºå¤±çš„åˆ—é»˜è®¤ä¸º0
                        quarters.forEach((quarter, idx) => {
                            const value = parts[idx + 1]; // å¯èƒ½ä¸ºundefined
                            const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);

                            if (input) {
                                if (value === undefined || value === '') {
                                    // ç¼ºå¤±çš„åˆ—è®¾ä¸º0
                                    input.value = '0.00';
                                    saveGapData(vehicle.code, quarter, '0.00');
                                } else {
                                    const numValue = parseFloat(value);
                                    if (!isNaN(numValue)) {
                                        input.value = numValue.toFixed(2);
                                        saveGapData(vehicle.code, quarter, input.value);
                                    } else {
                                        // æ— æ•ˆæ•°å€¼ä¹Ÿè®¾ä¸º0
                                        input.value = '0.00';
                                        saveGapData(vehicle.code, quarter, '0.00');
                                    }
                                }
                            }
                        });

                        updateVehicleTotal(vehicle.code);
                        importCount++;
                    }

                    updateSummary();

                    let message = `æˆåŠŸå¯¼å…¥ ${importCount} ä¸ªè½¦å‹çš„ç¼ºå£æ•°æ®ï¼`;
                    if (errorLines.length > 0 && errorLines.length < 10) {
                        message += '\n\nè·³è¿‡çš„è¡Œï¼š\n' + errorLines.join('\n');
                    } else if (errorLines.length >= 10) {
                        message += `\n\nè·³è¿‡äº† ${errorLines.length} è¡Œï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…`;
                        console.log('è·³è¿‡çš„è¡Œ:', errorLines);
                    }
                    alert(message);

                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                }
            };

            // å°è¯•å¤šç§ç¼–ç è¯»å–
            reader.readAsText(file, 'UTF-8');

            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // ===== æ¨¡å—2: è¿”åˆ©æƒ…å†µ =====
        let rebateData = [];
        let rebateIdCounter = 1;

        // åŠ è½½è¿”åˆ©æ•°æ®
        function loadRebateData() {
            const saved = localStorage.getItem('rebateData');
            if (saved) {
                rebateData = JSON.parse(saved);
                rebateIdCounter = Math.max(...rebateData.map(r => r.id), 0) + 1;
            }
            renderRebateTable();
        }

        // ä¿å­˜è¿”åˆ©æ•°æ®
        function saveRebateData() {
            localStorage.setItem('rebateData', JSON.stringify(rebateData));
        }

        // æ·»åŠ è¿”åˆ©è®°å½•
        function addRebateRow() {
            rebateData.push({
                id: rebateIdCounter++,
                manager: '',
                type: '',
                amount: '',
                supplier: '',
                vehicles: '',
                recommendedVehicles: '',
                recommendedTime: '',
                earliestSignQuarter: '',
                latestSignQuarter: '',
                note: ''
            });
            renderRebateTable();
            saveRebateData();
        }

        // åˆ é™¤è¿”åˆ©è®°å½•
        function deleteRebateRow(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¿”åˆ©è®°å½•å—ï¼Ÿ')) {
                rebateData = rebateData.filter(r => r.id !== id);
                renderRebateTable();
                saveRebateData();
                updateSummary();
            }
        }

        // æ¸²æŸ“è¿”åˆ©è¡¨æ ¼
        function renderRebateTable() {
            const tbody = document.getElementById('rebateTableBody');
            if (rebateData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;color:#ff69b4;">æš‚æ— æ•°æ®,ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ è¿”åˆ©è®°å½•</td></tr>';
                return;
            }

            let html = '';
            rebateData.forEach((item, index) => {
                html += `<tr>
                    <td>${index + 1}</td>
                    <td><input type="text" value="${item.manager || ''}" onchange="updateRebateField(${item.id}, 'manager', this.value)" placeholder="å§“å"></td>
                    <td>
                        <select onchange="updateRebateField(${item.id}, 'type', this.value)">
                            <option value="">è¯·é€‰æ‹©</option>
                            ${rebateTypes.map(t => `<option value="${t}" ${item.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${item.amount || ''}" onchange="updateRebateField(${item.id}, 'amount', this.value)" placeholder="0.00" step="0.01"></td>
                    <td><input type="text" value="${item.supplier || ''}" onchange="updateRebateField(${item.id}, 'supplier', this.value)" placeholder="ä¾›åº”å•†"></td>
                    <td><input type="text" value="${item.vehicles || ''}" onchange="updateRebateField(${item.id}, 'vehicles', this.value)" placeholder="X01,X02"></td>
                    <td><input type="text" value="${item.recommendedVehicles || ''}" onchange="updateRebateField(${item.id}, 'recommendedVehicles', this.value)" placeholder="X01,X02"></td>
                    <td><input type="text" value="${item.recommendedTime || ''}" onchange="updateRebateField(${item.id}, 'recommendedTime', this.value)" placeholder="2026.Q1"></td>
                    <td><input type="text" value="${item.earliestSignQuarter || ''}" onchange="updateRebateField(${item.id}, 'earliestSignQuarter', this.value)" placeholder="2026.Q1"></td>
                    <td><input type="text" value="${item.latestSignQuarter || ''}" onchange="updateRebateField(${item.id}, 'latestSignQuarter', this.value)" placeholder="2026.Q2"></td>
                    <td><input type="text" value="${item.note || ''}" onchange="updateRebateField(${item.id}, 'note', this.value)" placeholder="å¤‡æ³¨"></td>
                    <td><button class="delete-button" onclick="deleteRebateRow(${item.id})">åˆ é™¤</button></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // æ›´æ–°è¿”åˆ©å­—æ®µ
        function updateRebateField(id, field, value) {
            const item = rebateData.find(r => r.id === id);
            if (item) {
                item[field] = value;
                saveRebateData();
                if (field === 'amount') {
                    updateSummary();
                }
            }
        }

        // ä¸‹è½½è¿”åˆ©è®°å½•æ¨¡æ¿
        function downloadRebateTemplate() {
            // åˆ›å»ºCSVå†…å®¹
            let csv = '\uFEFFé‡‡è´­ç»ç†,è¿”åˆ©ç±»å‹,è¿”åˆ©é‡‘é¢(å…ƒ),ä¾›åº”å•†åç§°,ä¾›è´§è½¦å‹,æ¨èè½åœ°è½¦å‹,æ¨èè½åœ°æ—¶é—´,æœ€æ—©ç­¾ç½²æ—¶é—´,æœ€è¿Ÿç­¾ç½²æ—¶é—´,å¤‡æ³¨\n';
            // æ·»åŠ ç¤ºä¾‹è¡Œ
            csv += 'å¼ ä¸‰,ä¸€èˆ¬ä¸€æ¬¡æ€§è¿”åˆ©,100000,ä¾›åº”å•†A,X01,X01,2026.Q1,2026.Q1,2026.Q2,ç¤ºä¾‹å¤‡æ³¨\n';
            csv += 'æå››,é˜¶æ¢¯è¿”åˆ©,200000,ä¾›åº”å•†B,"X01,X02","X01,X02",2026.Q2,2026.Q2,2026.Q3,\n';

            // åˆ›å»ºä¸‹è½½
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'è¿”åˆ©è®°å½•æ¨¡æ¿.csv';
            link.click();
        }

        // å¯¼å…¥è¿”åˆ©è®°å½•æ•°æ®
        function importRebateData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    console.log('è¿”åˆ©æ–‡ä»¶å†…å®¹:', content.substring(0, 300)); // è°ƒè¯•ä¿¡æ¯

                    const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                    console.log('è¿”åˆ©æ€»è¡Œæ•°:', lines.length); // è°ƒè¯•ä¿¡æ¯

                    if (lines.length === 0) {
                        alert('æ–‡ä»¶ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼');
                        return;
                    }

                    // è·³è¿‡è¡¨å¤´
                    let startIndex = 0;
                    if (lines[0].includes('é‡‡è´­ç»ç†') || lines[0].includes('è¿”åˆ©ç±»å‹')) {
                        startIndex = 1;
                        console.log('æ£€æµ‹åˆ°è¿”åˆ©è¡¨å¤´:', lines[0]); // è°ƒè¯•ä¿¡æ¯
                    }

                    // è‡ªåŠ¨æ£€æµ‹åˆ†éš”ç¬¦
                    const sampleLine = lines[startIndex] || lines[0];
                    const delimiter = detectDelimiter(sampleLine);
                    console.log('è¿”åˆ©æ•°æ®æ£€æµ‹åˆ°åˆ†éš”ç¬¦:', delimiter === '\t' ? 'Tab' : delimiter); // è°ƒè¯•ä¿¡æ¯

                    let importCount = 0;
                    let errorLines = [];

                    for (let i = startIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        // è§£æCSVè¡Œï¼ˆæ”¯æŒå¸¦å¼•å·çš„å­—æ®µï¼‰
                        let parts;
                        if (delimiter === ',') {
                            // é€—å·åˆ†éš”ç¬¦éœ€è¦ç‰¹æ®Šå¤„ç†å¼•å·
                            parts = parseCSVLine(line);
                        } else {
                            // å…¶ä»–åˆ†éš”ç¬¦ç›´æ¥åˆ†å‰²
                            parts = line.split(delimiter).map(p => p.trim());
                        }

                        console.log(`è¿”åˆ©ç¬¬${i+1}è¡Œæ•°æ®:`, parts); // è°ƒè¯•ä¿¡æ¯

                        // è‡³å°‘éœ€è¦å‰4ä¸ªå¿…å¡«å­—æ®µï¼šé‡‡è´­ç»ç†ã€è¿”åˆ©ç±»å‹ã€è¿”åˆ©é‡‘é¢ã€ä¾›åº”å•†
                        if (parts.length < 4) {
                            errorLines.push(`ç¬¬${i+1}è¡Œï¼šå­—æ®µæ•°ä¸è¶³ï¼ˆè‡³å°‘éœ€è¦4ä¸ªå­—æ®µï¼Œå®é™…${parts.length}ä¸ªï¼‰`);
                            continue;
                        }

                        // åˆ›å»ºæ–°çš„è¿”åˆ©è®°å½•ï¼Œç¼ºå¤±å­—æ®µè‡ªåŠ¨å¡«ç©º
                        rebateData.push({
                            id: rebateIdCounter++,
                            manager: parts[0] || '',
                            type: parts[1] || '',
                            amount: parts[2] || '',
                            supplier: parts[3] || '',
                            vehicles: parts[4] || '',
                            recommendedVehicles: parts[5] || '',
                            recommendedTime: parts[6] || '',
                            earliestSignQuarter: parts[7] || '',
                            latestSignQuarter: parts[8] || '',
                            note: parts[9] || ''
                        });

                        importCount++;
                    }

                    renderRebateTable();
                    saveRebateData();
                    updateSummary();

                    let message = `æˆåŠŸå¯¼å…¥ ${importCount} æ¡è¿”åˆ©è®°å½•ï¼`;
                    if (errorLines.length > 0 && errorLines.length < 10) {
                        message += '\n\nè·³è¿‡çš„è¡Œï¼š\n' + errorLines.join('\n');
                    } else if (errorLines.length >= 10) {
                        message += `\n\nè·³è¿‡äº† ${errorLines.length} è¡Œï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…`;
                        console.log('è·³è¿‡çš„è¡Œ:', errorLines);
                    }
                    alert(message);

                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                }
            };
            reader.readAsText(file, 'UTF-8');

            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // è§£æCSVè¡Œï¼ˆå¤„ç†å¸¦å¼•å·çš„å­—æ®µï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            // æ·»åŠ æœ€åä¸€ä¸ªå­—æ®µ
            result.push(current.trim());

            return result;
        }

        // ===== è¿”åˆ©åˆ†é…ç®—æ³• =====

        // è§£æå­£åº¦å­—ç¬¦ä¸² (e.g., "2026.Q1" â†’ "Q1")
        function parseQuarter(quarterStr) {
            if (!quarterStr) return null;
            const match = quarterStr.match(/Q[1-4]/i);
            return match ? match[0].toUpperCase() : null;
        }

        // è·å–ä¸¤ä¸ªå­£åº¦ä¹‹é—´çš„æ‰€æœ‰å­£åº¦
        function getQuarterRange(startQ, endQ) {
            if (!startQ || !endQ) return [];
            const startIdx = quarters.indexOf(startQ);
            const endIdx = quarters.indexOf(endQ);
            if (startIdx === -1 || endIdx === -1) return [];

            const result = [];
            for (let i = startIdx; i <= endIdx; i++) {
                result.push(quarters[i]);
            }
            return result;
        }

        // æ‰§è¡Œæ™ºèƒ½åˆ†é…
        function performAllocation() {
            // 1. æ”¶é›†æ‰€æœ‰ç¼ºå£æ•°æ®
            const gaps = {};
            vehicles.forEach(vehicle => {
                gaps[vehicle.code] = {};
                quarters.forEach(quarter => {
                    const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                    const gapAmount = input && input.value ? parseFloat(input.value) : 0;
                    gaps[vehicle.code][quarter] = {
                        original: gapAmount,
                        allocated: 0,
                        sources: []
                    };
                });
            });

            // 2. éå†è¿”åˆ©è®°å½•ï¼Œè¿›è¡Œåˆ†é…
            rebateData.forEach(rebate => {
                if (!rebate.amount || !rebate.vehicles) return;

                const rebateAmount = parseFloat(rebate.amount);
                if (rebateAmount <= 0) return;

                // è§£æä¾›è´§è½¦å‹
                const rebateVehicles = rebate.vehicles.split(',').map(v => v.trim()).filter(v => v);
                if (rebateVehicles.length === 0) return;

                // è§£æç­¾ç½²æ—¶é—´èŒƒå›´
                const startQ = parseQuarter(rebate.earliestSignQuarter);
                const endQ = parseQuarter(rebate.latestSignQuarter);
                let applicableQuarters = [];

                if (startQ && endQ) {
                    applicableQuarters = getQuarterRange(startQ, endQ);
                } else if (startQ) {
                    applicableQuarters = [startQ];
                } else if (endQ) {
                    applicableQuarters = [endQ];
                } else {
                    // å¦‚æœæ²¡æœ‰æŒ‡å®šæ—¶é—´ï¼Œé»˜è®¤é€‚ç”¨æ‰€æœ‰å­£åº¦
                    applicableQuarters = [...quarters];
                }

                // æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è½¦å‹-å­£åº¦ç»„åˆ
                const matches = [];
                rebateVehicles.forEach(vehicleCode => {
                    if (gaps[vehicleCode]) {
                        applicableQuarters.forEach(quarter => {
                            if (gaps[vehicleCode][quarter] && gaps[vehicleCode][quarter].original > 0) {
                                matches.push({ vehicle: vehicleCode, quarter: quarter });
                            }
                        });
                    }
                });

                // å¦‚æœæ²¡æœ‰åŒ¹é…çš„ç¼ºå£ï¼Œè·³è¿‡
                if (matches.length === 0) return;

                // è®¡ç®—æ¯ä¸ªåŒ¹é…ç»„åˆçš„ç¼ºå£æ€»å’Œï¼ŒæŒ‰æ¯”ä¾‹åˆ†é…è¿”åˆ©
                let totalMatchedGap = 0;
                matches.forEach(m => {
                    const remainingGap = gaps[m.vehicle][m.quarter].original - gaps[m.vehicle][m.quarter].allocated;
                    totalMatchedGap += remainingGap;
                });

                // æŒ‰ç¼ºå£æ¯”ä¾‹åˆ†é…è¿”åˆ©é‡‘é¢
                matches.forEach(m => {
                    const remainingGap = gaps[m.vehicle][m.quarter].original - gaps[m.vehicle][m.quarter].allocated;
                    const proportion = remainingGap / totalMatchedGap;
                    const allocatedToThis = rebateAmount * proportion;

                    gaps[m.vehicle][m.quarter].allocated += allocatedToThis;
                    gaps[m.vehicle][m.quarter].sources.push({
                        rebateId: rebate.id,
                        supplier: rebate.supplier || 'æœªçŸ¥',
                        amount: allocatedToThis
                    });
                });
            });

            return gaps;
        }

        // æ¸²æŸ“åˆ†é…ç»“æœè¡¨æ ¼
        function renderAllocationTable() {
            const allocationResults = performAllocation();
            const tbody = document.getElementById('allocationTableBody');

            let html = '';
            vehicles.forEach(vehicle => {
                html += `<tr><td class="vehicle-label">${vehicle.icon} ${vehicle.name}</td>`;

                quarters.forEach(quarter => {
                    const data = allocationResults[vehicle.code][quarter];
                    const remaining = data.original - data.allocated;
                    const fillRate = data.original > 0 ? (data.allocated / data.original * 100).toFixed(1) : 0;

                    // æ ¹æ®å¡«å……æƒ…å†µè®¾ç½®èƒŒæ™¯è‰²
                    let bgColor = '#fff5f8';
                    if (fillRate >= 100) {
                        bgColor = '#d4edda'; // ç»¿è‰² - å®Œå…¨å¡«å……
                    } else if (fillRate >= 50) {
                        bgColor = '#fff3cd'; // é»„è‰² - éƒ¨åˆ†å¡«å……
                    } else if (fillRate > 0) {
                        bgColor = '#ffe4e1'; // æµ…çº¢ - å°‘é‡å¡«å……
                    }

                    html += `<td style="background: ${bgColor}; padding: 8px; font-size: 0.85em;">
                        <div><strong>åŸå§‹:</strong> Â¥${formatCurrency(data.original)}</div>
                        <div style="color: #28a745;"><strong>åˆ†é…:</strong> Â¥${formatCurrency(data.allocated)}</div>
                        <div style="color: ${remaining > 0 ? '#dc3545' : '#28a745'};"><strong>å‰©ä½™:</strong> Â¥${formatCurrency(remaining)}</div>
                        ${data.sources.length > 0 ? `<div style="font-size: 0.8em; margin-top: 4px; color: #666;">æ¥æº: ${data.sources.map(s => s.supplier).join(', ')}</div>` : ''}
                    </td>`;
                });

                // è®¡ç®—è¯¥è½¦å‹æ€»è®¡
                let vehicleOriginal = 0, vehicleAllocated = 0;
                quarters.forEach(q => {
                    vehicleOriginal += allocationResults[vehicle.code][q].original;
                    vehicleAllocated += allocationResults[vehicle.code][q].allocated;
                });
                const vehicleRemaining = vehicleOriginal - vehicleAllocated;

                html += `<td class="total-cell" style="font-size: 0.85em;">
                    <div>åŸå§‹: Â¥${formatCurrency(vehicleOriginal)}</div>
                    <div style="color: #28a745;">åˆ†é…: Â¥${formatCurrency(vehicleAllocated)}</div>
                    <div style="color: ${vehicleRemaining > 0 ? '#dc3545' : '#28a745'};">å‰©ä½™: Â¥${formatCurrency(vehicleRemaining)}</div>
                </td></tr>`;
            });

            tbody.innerHTML = html;
        }

        // ===== ç»Ÿè®¡æ±‡æ€» =====
        function updateSummary() {
            // è®¡ç®—æ€»æŒ‡æ ‡ç¼ºå£
            let totalGap = 0;
            vehicles.forEach(vehicle => {
                quarters.forEach(quarter => {
                    const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                    if (input && input.value) {
                        totalGap += parseFloat(input.value);
                    }
                });
            });

            // è®¡ç®—æ€»è¿”åˆ©é‡‘é¢
            let totalRebate = 0;
            rebateData.forEach(item => {
                if (item.amount) {
                    totalRebate += parseFloat(item.amount);
                }
            });

            // è®¡ç®—å‰©ä½™ç¼ºå£
            const remaining = totalGap - totalRebate;

            // è®¡ç®—å¡«å……ç‡
            const fillRate = totalGap > 0 ? ((totalRebate / totalGap) * 100).toFixed(1) : 0;

            document.getElementById('totalGap').textContent = `Â¥${formatCurrency(totalGap)}`;
            document.getElementById('totalRebate').textContent = `Â¥${formatCurrency(totalRebate)}`;
            document.getElementById('remainingGap').textContent = `Â¥${formatCurrency(remaining)}`;
            document.getElementById('fillRate').textContent = `${fillRate}%`;
        }

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            generateGapTable();
            loadGapData();
            loadRebateData();
            updateSummary();
        });
    </script>
</body>
</html>