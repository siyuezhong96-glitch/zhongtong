<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿”åˆ©è°ƒé…ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’°</text></svg>">
    <!-- SheetJSåº“ç”¨äºExcelæ–‡ä»¶å¤„ç† -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #ffd6e8 50%, #ffb3d9 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease-out;
        }

        h1 {
            color: #ff69b4;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(255, 105, 180, 0.3);
        }

        .subtitle {
            color: #ff1493;
            font-size: 1.1em;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.2);
            animation: fadeInUp 0.6s ease-out;
        }

        .section-title {
            font-size: 1.8em;
            color: #ff1493;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            overflow-x: auto;
        }

        #rebateTable {
            min-width: 3500px;
        }

        .data-table th {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            padding: 12px 10px;
            font-weight: 600;
            text-align: center;
            border: 2px solid #ff1493;
            font-size: 0.95em;
            white-space: nowrap;
        }

        .data-table th:first-child {
            border-top-left-radius: 12px;
        }

        .data-table th:last-child {
            border-top-right-radius: 12px;
        }

        .data-table td {
            padding: 8px;
            border: 2px solid #ffc0cb;
            background: #fff5f8;
            text-align: center;
            white-space: nowrap;
        }

        .data-table td.vehicle-label {
            background: linear-gradient(135deg, #fff5f8 0%, #ffe4f0 100%);
            font-weight: 600;
            color: #ff1493;
            font-size: 1.05em;
        }

        .data-table input, .data-table select {
            width: 100%;
            min-width: 80px;
            padding: 8px;
            border: 2px solid #ffc0cb;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background: white;
            white-space: nowrap;
        }

        .data-table input:focus, .data-table select:focus {
            outline: none;
            border-color: #ff69b4;
            box-shadow: 0 0 8px rgba(255, 105, 180, 0.3);
        }

        .data-table input[type="number"] {
            text-align: right;
        }

        .data-table .total-cell {
            background: linear-gradient(135deg, #ffe4f0 0%, #ffd6e8 100%);
            font-weight: 600;
            color: #ff1493;
            font-size: 1.05em;
        }

        .add-button {
            display: inline-block;
            margin: 15px 0;
            padding: 10px 25px;
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(255, 105, 180, 0.3);
        }

        .add-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 105, 180, 0.4);
        }

        .delete-button {
            padding: 4px 10px;
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-button:hover {
            background: #ff1493;
        }

        .summary-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.2);
            animation: fadeInUp 0.8s ease-out;
        }

        .summary-title {
            font-size: 1.8em;
            color: #ff1493;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #fff5f8 0%, #ffe4f0 100%);
            border-radius: 15px;
            border: 2px solid #ffc0cb;
        }

        .summary-label {
            color: #ff69b4;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .summary-value {
            color: #ff1493;
            font-size: 1.6em;
            font-weight: bold;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .section {
                padding: 15px;
            }

            .data-table th,
            .data-table td {
                padding: 6px 4px;
                font-size: 0.85em;
            }

            .data-table input, .data-table select {
                padding: 6px;
                font-size: 0.85em;
            }
        }

        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
            border: 2px solid #ffc0cb;
            border-radius: 12px;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 12px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #fff5f8;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #ff69b4;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #ff1493;
        }

        /* è¿”åˆ©æƒ…å†µè¡¨æ ¼æ»šåŠ¨æ ·å¼ */
        #rebateTableWrapper {
            max-height: 750px;
            overflow-y: auto;
        }

        #rebateTableWrapper::-webkit-scrollbar {
            width: 12px;
        }

        #rebateTableWrapper::-webkit-scrollbar-track {
            background: #fff5f8;
            border-radius: 6px;
        }

        #rebateTableWrapper::-webkit-scrollbar-thumb {
            background: #ff69b4;
            border-radius: 6px;
        }

        #rebateTableWrapper::-webkit-scrollbar-thumb:hover {
            background: #ff1493;
        }

        /* è¿”åˆ©è¡¨æ ¼å›ºå®šè¡¨å¤´ */
        #rebateTable thead th {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* è¿”åˆ©è¡¨æ ¼è¡Œé«˜è°ƒæ•´ */
        #rebateTable td {
            padding: 6px;
        }

        #rebateTable input,
        #rebateTable select {
            padding: 6px;
        }

        /* å¯çˆ±è£…é¥°å…ƒç´  */
        .decoration-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .float-decoration {
            position: absolute;
            animation: float 8s ease-in-out infinite;
            opacity: 0.6;
        }

        .float-decoration:nth-child(1) {
            top: 10%;
            left: 5%;
            animation-delay: 0s;
            animation-duration: 10s;
        }

        .float-decoration:nth-child(2) {
            top: 20%;
            right: 8%;
            animation-delay: 2s;
            animation-duration: 12s;
        }

        .float-decoration:nth-child(3) {
            top: 60%;
            left: 3%;
            animation-delay: 4s;
            animation-duration: 9s;
        }

        .float-decoration:nth-child(4) {
            top: 70%;
            right: 5%;
            animation-delay: 1s;
            animation-duration: 11s;
        }

        .float-decoration:nth-child(5) {
            top: 40%;
            left: 10%;
            animation-delay: 3s;
            animation-duration: 13s;
        }

        .float-decoration:nth-child(6) {
            top: 50%;
            right: 12%;
            animation-delay: 5s;
            animation-duration: 10s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            25% {
                transform: translateY(-20px) rotate(5deg);
            }
            50% {
                transform: translateY(-10px) rotate(-5deg);
            }
            75% {
                transform: translateY(-15px) rotate(3deg);
            }
        }

        /* é¡µé¢è§’è½è£…é¥° */
        .corner-decoration {
            position: fixed;
            pointer-events: none;
            z-index: 1;
            opacity: 0.3;
        }

        .corner-top-left {
            top: 0;
            left: 0;
            font-size: 8em;
            transform: rotate(-15deg);
        }

        .corner-top-right {
            top: 0;
            right: 0;
            font-size: 6em;
            transform: rotate(15deg);
        }

        .corner-bottom-left {
            bottom: 20px;
            left: 0;
            font-size: 7em;
            transform: rotate(15deg);
        }

        .corner-bottom-right {
            bottom: 20px;
            right: 0;
            font-size: 5em;
            transform: rotate(-20deg);
        }

        /* é—ªçƒæ˜Ÿæ˜Ÿæ•ˆæœ */
        @keyframes twinkle {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        .twinkle {
            animation: twinkle 3s ease-in-out infinite;
        }

        .twinkle:nth-child(even) {
            animation-delay: 1.5s;
        }
    </style>
</head>
<body>
    <!-- å¯çˆ±çš„æµ®åŠ¨è£…é¥°å…ƒç´  -->
    <div class="decoration-container">
        <div class="float-decoration twinkle" style="font-size: 3em;">ğŸ’–</div>
        <div class="float-decoration" style="font-size: 2.5em;">ğŸš—</div>
        <div class="float-decoration twinkle" style="font-size: 2em;">â­</div>
        <div class="float-decoration" style="font-size: 2.8em;">ğŸ€</div>
        <div class="float-decoration twinkle" style="font-size: 2.2em;">âœ¨</div>
        <div class="float-decoration" style="font-size: 3em;">ğŸ’</div>
    </div>

    <!-- é¡µé¢è§’è½è£…é¥° -->
    <div class="corner-decoration corner-top-left">ğŸŒ¸</div>
    <div class="corner-decoration corner-top-right">ğŸˆ</div>
    <div class="corner-decoration corner-bottom-left">ğŸŒº</div>
    <div class="corner-decoration corner-bottom-right">ğŸ¦‹</div>

    <div class="container">
        <header>
            <h1>ğŸ’° è¿”åˆ©è°ƒé…ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="subtitle">ç®¡ç†è½¦å‹æŒ‡æ ‡ç¼ºå£ä¸è¿”åˆ©è°ƒé…ï¼Œæ™ºèƒ½åˆ†é…èµ„é‡‘å¡«è¡¥ç¼ºå£</p>
        </header>

        <!-- æ¨¡å—1: å½“å‰æŒ‡æ ‡ç¼ºå£ -->
        <div class="section">
            <h2 class="section-title">1. å½“å‰æŒ‡æ ‡ç¼ºå£</h2>
            <div style="margin-bottom: 15px;">
                <button class="add-button" onclick="downloadGapTemplate()">ğŸ“¥ ä¸‹è½½ç¼ºå£æ¨¡æ¿</button>
                <button class="add-button" onclick="document.getElementById('gapFileInput').click()">ğŸ“¤ å¯¼å…¥ç¼ºå£æ•°æ®</button>
                <button class="add-button" onclick="clearAllGapData()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼ºå£æ•°æ®</button>
                <input type="file" id="gapFileInput" accept=".xlsx,.xls" style="display:none;" onchange="importGapData(event)">
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="gapTable">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </table>
            </div>
        </div>

        <!-- æ¨¡å—2: è¿”åˆ©æƒ…å†µ -->
        <div class="section">
            <h2 class="section-title">2. è¿”åˆ©æƒ…å†µ</h2>
            <div style="margin-bottom: 15px;">
                <button class="add-button" onclick="addRebateRow()">â• æ·»åŠ è¿”åˆ©è®°å½•</button>
                <button class="add-button" onclick="downloadRebateTemplate()">ğŸ“¥ ä¸‹è½½è¿”åˆ©æ¨¡æ¿</button>
                <button class="add-button" onclick="document.getElementById('rebateFileInput').click()">ğŸ“¤ å¯¼å…¥è¿”åˆ©æ•°æ®</button>
                <button class="add-button" onclick="exportRebateData()" style="background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);">ğŸ’¾ å¯¼å‡ºè¿”åˆ©æ•°æ®</button>
                <button class="add-button" onclick="clearAllRebateData()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è¿”åˆ©æ•°æ®</button>
                <input type="file" id="rebateFileInput" accept=".xlsx,.xls" style="display:none;" onchange="importRebateData(event)">
            </div>
            <div class="table-wrapper" id="rebateTableWrapper">
                <table class="data-table" id="rebateTable">
                    <thead>
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 100px;">ææŠ¥æ—¥æœŸ</th>
                            <th style="width: 100px;">é‡‡è´­ç»ç†*</th>
                            <th style="width: 120px;">è¿”åˆ©ç±»å‹*</th>
                            <th style="width: 100px;">è¿”åˆ©å•ä»·</th>
                            <th style="width: 120px;">å•ä»·è¿”åˆ©è½¦å‹</th>
                            <th style="width: 120px;">é›¶ä»¶/SORåŒ…</th>
                            <th style="width: 160px;">ä¾›åº”å•†åç§°*</th>
                            <th style="width: 130px;">ä¾›åº”å•†ä¾›è´§è½¦å‹*</th>
                            <th style="width: 120px;">ä¸šåŠ¡å‘ç”Ÿæ—¶é—´èµ·ç‚¹</th>
                            <th style="width: 120px;">ä¸šåŠ¡å‘ç”Ÿæ—¶é—´ç»ˆç‚¹</th>
                            <th style="width: 130px;">å…¬å‡½/åè®®æœ€æ—©ç­¾ç½²æ—¶é—´*</th>
                            <th style="width: 130px;">å…¬å‡½/åè®®æœ€è¿Ÿç­¾ç½²æ—¶é—´*</th>
                            <th style="width: 100px;">é™„ä»¶</th>
                            <th style="width: 150px;">å¤‡æ³¨</th>
                            <th style="width: 120px;">è¿”åˆ©è®¡ç®—é‡çº²</th>
                            <th style="width: 120px;">è¿”åˆ©é‡‘é¢*</th>
                            <th style="width: 120px;">ä¾›åº”å•†ç¼–ç *</th>
                            <th style="width: 120px;">é‡‡è´­-ä¸€çº§éƒ¨é—¨*</th>
                            <th style="width: 120px;">é‡‡è´­-äºŒçº§éƒ¨é—¨*</th>
                            <th style="width: 130px;">æ¨èè½åœ°è½¦å‹</th>
                            <th style="width: 130px;">æ¨èè½åœ°æ—¶é—´</th>
                            <th style="width: 70px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rebateTableBody">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ¨¡å—3: è¿”åˆ©åˆ†é…ç»“æœ -->
        <div class="section">
            <h2 class="section-title">3. è¿”åˆ©åˆ†é…ç»“æœ</h2>
            <button class="add-button" onclick="renderAllocationTable()">ğŸ”„ æ‰§è¡Œæ™ºèƒ½åˆ†é…</button>
            <div class="table-wrapper">
                <table class="data-table" id="allocationTable">
                    <thead>
                        <tr>
                            <th style="width: 120px;">è½¦å‹</th>
                            <th>2026 Q1</th>
                            <th>2026 Q2</th>
                            <th>2026 Q3</th>
                            <th>2026 Q4</th>
                            <th>åˆè®¡</th>
                        </tr>
                    </thead>
                    <tbody id="allocationTableBody">
                        <tr><td colspan="6" style="text-align:center;color:#ff69b4;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ‰§è¡Œæ™ºèƒ½åˆ†é…</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #fff5f8; border-radius: 10px; border: 2px solid #ffc0cb;">
                <h3 style="color: #ff1493; margin-bottom: 10px;">ğŸ“Œ åˆ†é…è§„åˆ™è¯´æ˜</h3>
                <ul style="color: #ff69b4; line-height: 1.8;">
                    <li>ç³»ç»Ÿæ ¹æ®è¿”åˆ©è®°å½•ä¸­çš„"ä¾›è´§è½¦å‹"å’Œ"ç­¾ç½²æ—¶é—´èŒƒå›´"è‡ªåŠ¨åŒ¹é…å¯¹åº”çš„ç¼ºå£</li>
                    <li>æ¯ç¬”è¿”åˆ©å®Œæ•´åˆ†é…ç»™å•ä¸€è½¦å‹-å­£åº¦ï¼Œä¸æ‹†åˆ†åˆ†é…</li>
                    <li>å­£åº¦ä¼˜å…ˆçº§ï¼šQ1 > Q2 > Q3 > Q4ï¼Œä¼˜å…ˆå…³é—­æ—©æœŸç¼ºå£</li>
                    <li>è½¦å‹é€‰æ‹©ç­–ç•¥ï¼šåœ¨åŒä¸€å­£åº¦å†…ä¼˜å…ˆåˆ†é…ç»™ç¼ºå£æœ€å¤§çš„è½¦å‹</li>
                    <li>é¢œè‰²è¯´æ˜ï¼š<span style="background: #d4edda; padding: 2px 8px; border-radius: 4px;">ç»¿è‰²=å®Œå…¨å¡«å……(100%)</span> <span style="background: #fff3cd; padding: 2px 8px; border-radius: 4px;">é»„è‰²=å¡«å……>50%</span> <span style="background: #ffe4e1; padding: 2px 8px; border-radius: 4px;">æµ…çº¢=å¡«å……<20%</span></li>
                </ul>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ±‡æ€» -->
        <div class="summary-section">
            <h2 class="summary-title">ğŸ“Š æŒ‡æ ‡ç¼ºå£ä¸è¿”åˆ©æ±‡æ€»</h2>
            <div class="summary-content">
                <div class="summary-item">
                    <div class="summary-label">æ€»æŒ‡æ ‡ç¼ºå£</div>
                    <div class="summary-value" id="totalGap">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æ€»è¿”åˆ©é‡‘é¢</div>
                    <div class="summary-value" id="totalRebate">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">å‰©ä½™ç¼ºå£</div>
                    <div class="summary-value" id="remainingGap">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">å¡«å……ç‡</div>
                    <div class="summary-value" id="fillRate">0%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è½¦å‹é…ç½®
        const vehicles = [
            { code: 'X01', name: 'X01', icon: 'ğŸš™' },
            { code: 'X02', name: 'X02', icon: 'ğŸš™' },
            { code: 'X03', name: 'X03', icon: 'ğŸš™' },
            { code: 'X04', name: 'X04', icon: 'ğŸš™' },
            { code: 'W01', name: 'W01', icon: 'ğŸš' },
            { code: 'W02', name: 'W02', icon: 'ğŸš™' },
            { code: 'W04', name: 'W04', icon: 'ğŸš™' }
        ];

        const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];

        // è¿”åˆ©ç±»å‹é€‰é¡¹
        const rebateTypes = [
            'ä¸€èˆ¬ä¸€æ¬¡æ€§è¿”åˆ©',
            'é˜¶æ¢¯è¿”åˆ©',
            'å¹´åº¦è¿”åˆ©',
            'å…¶ä»–'
        ];

        // æ ¼å¼åŒ–æ•°å­—
        function formatCurrency(value) {
            if (!value || value === '') return '0.00';
            const num = parseFloat(value);
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // ===== æ¨¡å—1: æŒ‡æ ‡ç¼ºå£è¡¨æ ¼ =====
        function generateGapTable() {
            const table = document.getElementById('gapTable');
            let html = '<thead><tr><th style="width: 120px;">è½¦å‹</th>';

            // è¡¨å¤´ï¼šå­£åº¦åˆ— - ç¼©å°å®½åº¦
            quarters.forEach(q => {
                html += `<th style="width: 150px;">2026 ${q}</th>`;
            });
            html += '<th style="width: 180px;">åˆè®¡</th></tr></thead><tbody>';

            // æ•°æ®è¡Œï¼šæ¯ä¸ªè½¦å‹ä¸€è¡Œ
            vehicles.forEach(vehicle => {
                html += `<tr><td class="vehicle-label">${vehicle.icon} ${vehicle.name}</td>`;
                quarters.forEach(q => {
                    html += `<td>
                        <input type="text"
                               data-vehicle="${vehicle.code}"
                               data-quarter="${q}"
                               placeholder="0.00"
                               style="text-align: right;">
                    </td>`;
                });
                html += `<td class="total-cell" id="${vehicle.code}-total">Â¥0.00</td></tr>`;
            });

            // æ±‡æ€»è¡Œ
            html += `<tr style="background: linear-gradient(135deg, #ffe4f0 0%, #ffd6e8 100%); font-weight: 700;">
                <td class="vehicle-label" style="font-size: 1.1em;">ğŸ“Š æ±‡æ€»</td>`;
            quarters.forEach(q => {
                html += `<td class="total-cell" id="summary-${q}" style="font-size: 1.05em;">Â¥0.00</td>`;
            });
            html += `<td class="total-cell" id="summary-total" style="font-size: 1.1em; color: #ff1493;">Â¥0.00</td></tr>`;

            html += '</tbody>';
            table.innerHTML = html;

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.querySelectorAll('#gapTable input').forEach(input => {
                // è·å–ç„¦ç‚¹æ—¶å»é™¤åƒåˆ†ç¬¦ï¼Œä¾¿äºç¼–è¾‘
                input.addEventListener('focus', function() {
                    if (this.value) {
                        // å»é™¤åƒåˆ†ç¬¦
                        this.value = this.value.replace(/,/g, '');
                    }
                });

                input.addEventListener('input', function() {
                    // ä¿å­˜æ—¶å»é™¤åƒåˆ†ç¬¦
                    const rawValue = this.value.replace(/,/g, '');
                    saveGapData(this.dataset.vehicle, this.dataset.quarter, rawValue);
                    updateVehicleTotal(this.dataset.vehicle);
                    updateGapSummaryRow();
                    updateSummary();
                });

                // å¤±å»ç„¦ç‚¹æ—¶æ ¼å¼åŒ–ä¸ºåƒåˆ†ç¬¦+ä¸¤ä½å°æ•°
                input.addEventListener('blur', function() {
                    if (this.value) {
                        const num = parseFloat(this.value.replace(/,/g, ''));
                        if (!isNaN(num)) {
                            this.value = num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        }
                    }
                });
            });
        }

        // ä¿å­˜æŒ‡æ ‡ç¼ºå£æ•°æ®
        function saveGapData(vehicle, quarter, value) {
            const key = `gap_${vehicle}_${quarter}`;
            localStorage.setItem(key, value);
        }

        // åŠ è½½æŒ‡æ ‡ç¼ºå£æ•°æ®
        function loadGapData() {
            vehicles.forEach(vehicle => {
                quarters.forEach(quarter => {
                    const key = `gap_${vehicle.code}_${quarter}`;
                    const value = localStorage.getItem(key);
                    if (value) {
                        const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                        if (input) {
                            // æ ¼å¼åŒ–ä¸ºåƒåˆ†ç¬¦å’Œä¸¤ä½å°æ•°æ˜¾ç¤º
                            const numValue = parseFloat(value);
                            if (!isNaN(numValue)) {
                                input.value = numValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                            } else {
                                input.value = value;
                            }
                        }
                    }
                });
                updateVehicleTotal(vehicle.code);
            });
            updateGapSummaryRow();
        }

        // æ¸…é™¤æ‰€æœ‰ç¼ºå£æ•°æ®
        function clearAllGapData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼ºå£æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            // æ¸…é™¤localStorageä¸­çš„ç¼ºå£æ•°æ®
            vehicles.forEach(vehicle => {
                quarters.forEach(quarter => {
                    const key = `gap_${vehicle.code}_${quarter}`;
                    localStorage.removeItem(key);
                });
            });

            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
            vehicles.forEach(vehicle => {
                quarters.forEach(quarter => {
                    const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                    if (input) {
                        input.value = '0.00';
                    }
                });
                updateVehicleTotal(vehicle.code);
            });

            // æ›´æ–°æ±‡æ€»è¡Œ
            updateGapSummaryRow();

            // æ›´æ–°ç»Ÿè®¡æ±‡æ€»
            updateSummary();

            alert('æ‰€æœ‰ç¼ºå£æ•°æ®å·²æ¸…é™¤ï¼');
        }

        // æ›´æ–°å•ä¸ªè½¦å‹åˆè®¡
        function updateVehicleTotal(vehicleCode) {
            let total = 0;
            quarters.forEach(quarter => {
                const input = document.querySelector(`#gapTable [data-vehicle="${vehicleCode}"][data-quarter="${quarter}"]`);
                if (input && input.value) {
                    // å»é™¤åƒåˆ†ç¬¦åå†è§£æ
                    total += parseFloat(input.value.replace(/,/g, ''));
                }
            });
            const totalElement = document.getElementById(`${vehicleCode}-total`);
            if (totalElement) {
                totalElement.textContent = `Â¥${formatCurrency(total)}`;
            }
        }

        // æ›´æ–°æ±‡æ€»è¡Œ
        function updateGapSummaryRow() {
            let grandTotal = 0;

            // æ›´æ–°æ¯ä¸ªå­£åº¦çš„æ±‡æ€»
            quarters.forEach(quarter => {
                let quarterTotal = 0;
                vehicles.forEach(vehicle => {
                    const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                    if (input && input.value) {
                        // å»é™¤åƒåˆ†ç¬¦åå†è§£æ
                        quarterTotal += parseFloat(input.value.replace(/,/g, ''));
                    }
                });
                grandTotal += quarterTotal;

                const summaryElement = document.getElementById(`summary-${quarter}`);
                if (summaryElement) {
                    summaryElement.textContent = `Â¥${formatCurrency(quarterTotal)}`;
                }
            });

            // æ›´æ–°æ€»è®¡
            const summaryTotalElement = document.getElementById('summary-total');
            if (summaryTotalElement) {
                summaryTotalElement.textContent = `Â¥${formatCurrency(grandTotal)}`;
            }
        }

        // ä¸‹è½½æŒ‡æ ‡ç¼ºå£æ¨¡æ¿
        function downloadGapTemplate() {
            // åˆ›å»ºå·¥ä½œç°¿æ•°æ®
            const data = [['è½¦å‹', '2026 Q1', '2026 Q2', '2026 Q3', '2026 Q4']];
            vehicles.forEach(vehicle => {
                data.push([vehicle.name, 0, 0, 0, 0]);
            });

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(data);

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æŒ‡æ ‡ç¼ºå£');

            // ä¸‹è½½Excelæ–‡ä»¶
            XLSX.writeFile(wb, 'æŒ‡æ ‡ç¼ºå£æ¨¡æ¿.xlsx');
        }

        // è‡ªåŠ¨æ£€æµ‹CSVåˆ†éš”ç¬¦
        function detectDelimiter(line) {
            const delimiters = [',', '\t', ';', '|'];
            let bestDelimiter = ',';
            let maxCount = 0;

            for (const delimiter of delimiters) {
                const count = (line.match(new RegExp('\\' + delimiter, 'g')) || []).length;
                if (count > maxCount) {
                    maxCount = count;
                    bestDelimiter = delimiter;
                }
            }

            return bestDelimiter;
        }

        // å¯¼å…¥æŒ‡æ ‡ç¼ºå£æ•°æ®
        function importGapData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSONæ ¼å¼
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    processGapData(jsonData);
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                }
            };

            // è¯»å–ä¸ºArrayBuffer
            reader.readAsArrayBuffer(file);

            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // å¤„ç†æŒ‡æ ‡ç¼ºå£æ•°æ®
        function processGapData(jsonData) {
            console.log('==== å¼€å§‹å¤„ç†ç¼ºå£æ•°æ® ====');
            console.log('Excelæ•°æ®:', jsonData);

            if (!jsonData || jsonData.length === 0) {
                alert('æ–‡ä»¶ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼');
                return;
            }

            // è·³è¿‡è¡¨å¤´ï¼ˆç¬¬ä¸€è¡Œï¼‰
            let startIndex = 0;
            const firstRow = jsonData[0];
            if (firstRow && (firstRow[0] === 'è½¦å‹' || String(firstRow[1]).includes('Q1'))) {
                startIndex = 1;
                console.log('æ£€æµ‹åˆ°è¡¨å¤´ï¼Œä»ç¬¬2è¡Œå¼€å§‹:', firstRow);
            }

            let importCount = 0;
            let errorLines = [];

            for (let i = startIndex; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                const vehicleCode = String(row[0] || '').trim();
                if (!vehicleCode) continue;

                console.log(`å¤„ç†ç¬¬${i+1}è¡Œ: è½¦å‹=${vehicleCode}, æ•°æ®=`, row);

                const vehicle = vehicles.find(v => v.code === vehicleCode || v.name === vehicleCode);

                if (!vehicle) {
                    console.error(`è½¦å‹ä¸åŒ¹é…: ${vehicleCode}`);
                    errorLines.push(`ç¬¬${i+1}è¡Œï¼šè½¦å‹"${vehicleCode}"ä¸å­˜åœ¨ï¼ˆæœ‰æ•ˆè½¦å‹ï¼šX01,X02,X03,X04,W01,W02,W04ï¼‰`);
                    continue;
                }

                console.log(`æ‰¾åˆ°è½¦å‹: code=${vehicle.code}, name=${vehicle.name}`);

                // å¯¼å…¥4ä¸ªå­£åº¦çš„æ•°æ®
                quarters.forEach((quarter, idx) => {
                    const value = row[idx + 1];
                    const selector = `#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`;
                    const input = document.querySelector(selector);

                    console.log(`  ${quarter}: å€¼=${value}, é€‰æ‹©å™¨=${selector}, æ‰¾åˆ°è¾“å…¥æ¡†=${!!input}`);

                    if (input) {
                        if (value === undefined || value === '' || value === null) {
                            input.value = '0.00';
                            saveGapData(vehicle.code, quarter, '0.00');
                            console.log(`    è®¾ç½®ä¸º0.00`);
                        } else {
                            const numValue = parseFloat(value);
                            if (!isNaN(numValue)) {
                                const formattedValue = numValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                input.value = formattedValue;
                                saveGapData(vehicle.code, quarter, numValue);
                                console.log(`    è®¾ç½®ä¸º${formattedValue}, ä¿å­˜=${numValue}`);
                            } else {
                                input.value = '0.00';
                                saveGapData(vehicle.code, quarter, '0.00');
                                console.log(`    æ— æ•ˆå€¼ï¼Œè®¾ç½®ä¸º0.00`);
                            }
                        }
                    } else {
                        console.error(`    æœªæ‰¾åˆ°è¾“å…¥æ¡†ï¼`);
                    }
                });

                updateVehicleTotal(vehicle.code);
                importCount++;
            }

            console.log(`==== å¯¼å…¥å®Œæˆ: ${importCount}ä¸ªè½¦å‹ ====`);

            updateGapSummaryRow();
            updateSummary();

            let message = `æˆåŠŸå¯¼å…¥ ${importCount} ä¸ªè½¦å‹çš„ç¼ºå£æ•°æ®ï¼`;
            if (errorLines.length > 0 && errorLines.length < 10) {
                message += '\n\nè·³è¿‡çš„è¡Œï¼š\n' + errorLines.join('\n');
            } else if (errorLines.length >= 10) {
                message += `\n\nè·³è¿‡äº† ${errorLines.length} è¡Œï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…`;
                console.log('è·³è¿‡çš„è¡Œ:', errorLines);
            }
            alert(message);
        }

        // ===== æ¨¡å—2: è¿”åˆ©æƒ…å†µ =====
        let rebateData = [];
        let rebateIdCounter = 1;

        // åŠ è½½è¿”åˆ©æ•°æ®
        function loadRebateData() {
            const saved = localStorage.getItem('rebateData');
            if (saved) {
                rebateData = JSON.parse(saved);
                rebateIdCounter = Math.max(...rebateData.map(r => r.id), 0) + 1;
            }
            renderRebateTable();
        }

        // ä¿å­˜è¿”åˆ©æ•°æ®
        function saveRebateData() {
            localStorage.setItem('rebateData', JSON.stringify(rebateData));
        }

        // æ·»åŠ è¿”åˆ©è®°å½•
        function addRebateRow() {
            rebateData.push({
                id: rebateIdCounter++,
                submitDate: '',
                manager: '',
                type: '',
                unitPrice: '',
                unitPriceVehicles: '',
                partsSOR: '',
                supplier: '',
                vehicles: '',
                businessStartTime: '',
                businessEndTime: '',
                earliestSignQuarter: '',
                latestSignQuarter: '',
                attachment: '',
                note: '',
                calculationUnit: '',
                amount: '',
                supplierCode: '',
                department1: '',
                department2: '',
                recommendedVehicles: '',
                recommendedTime: ''
            });
            renderRebateTable();
            saveRebateData();
        }

        // åˆ é™¤è¿”åˆ©è®°å½•
        function deleteRebateRow(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¿”åˆ©è®°å½•å—ï¼Ÿ')) {
                rebateData = rebateData.filter(r => r.id !== id);
                renderRebateTable();
                saveRebateData();
                updateSummary();
            }
        }

        // æ¸…é™¤æ‰€æœ‰è¿”åˆ©æ•°æ®
        function clearAllRebateData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¿”åˆ©æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰ ' + rebateData.length + ' æ¡è¿”åˆ©è®°å½•å—ï¼Ÿ')) {
                    rebateData = [];
                    rebateIdCounter = 1;
                    renderRebateTable();
                    saveRebateData();
                    updateSummary();
                    alert('âœ… æ‰€æœ‰è¿”åˆ©æ•°æ®å·²æ¸…é™¤ï¼');
                }
            }
        }

        // æ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤ºï¼ˆåƒåˆ†ç¬¦+ä¸¤ä½å°æ•°ï¼‰
        function formatAmountDisplay(value) {
            if (!value || value === '') return '';
            const num = parseFloat(value.toString().replace(/,/g, ''));
            if (isNaN(num)) return '';
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // æ¸²æŸ“è¿”åˆ©è¡¨æ ¼
        function renderRebateTable() {
            const tbody = document.getElementById('rebateTableBody');
            if (rebateData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="23" style="text-align:center;color:#ff69b4;">æš‚æ— æ•°æ®,ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ è¿”åˆ©è®°å½•</td></tr>';
                return;
            }

            let html = '';
            rebateData.forEach((item, index) => {
                html += `<tr>
                    <td style="font-size: 0.85em; color: #888;">${index + 1}</td>
                    <td><input type="date" value="${item.submitDate || ''}" onchange="updateRebateField(${item.id}, 'submitDate', this.value)"></td>
                    <td><input type="text" value="${item.manager || ''}" onchange="updateRebateField(${item.id}, 'manager', this.value)" placeholder="å§“å" required></td>
                    <td>
                        <select onchange="updateRebateField(${item.id}, 'type', this.value)" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            ${rebateTypes.map(t => `<option value="${t}" ${item.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${item.unitPrice || ''}" onchange="updateRebateField(${item.id}, 'unitPrice', this.value)" placeholder="0.00" step="0.01"></td>
                    <td><input type="text" value="${item.unitPriceVehicles || ''}" onchange="updateRebateField(${item.id}, 'unitPriceVehicles', this.value)" placeholder="X01,X02"></td>
                    <td><input type="text" value="${item.partsSOR || ''}" onchange="updateRebateField(${item.id}, 'partsSOR', this.value)" placeholder="é›¶ä»¶/SORåŒ…"></td>
                    <td><input type="text" value="${item.supplier || ''}" onchange="updateRebateField(${item.id}, 'supplier', this.value)" placeholder="ä¾›åº”å•†åç§°" required></td>
                    <td><input type="text" value="${item.vehicles || ''}" onchange="updateRebateField(${item.id}, 'vehicles', this.value)" placeholder="X01,X02" required></td>
                    <td><input type="date" value="${item.businessStartTime || ''}" onchange="updateRebateField(${item.id}, 'businessStartTime', this.value)"></td>
                    <td><input type="date" value="${item.businessEndTime || ''}" onchange="updateRebateField(${item.id}, 'businessEndTime', this.value)"></td>
                    <td><input type="text" value="${item.earliestSignQuarter || ''}" onchange="updateRebateField(${item.id}, 'earliestSignQuarter', this.value)" placeholder="2026.Q1" required></td>
                    <td><input type="text" value="${item.latestSignQuarter || ''}" onchange="updateRebateField(${item.id}, 'latestSignQuarter', this.value)" placeholder="2026.Q2" required></td>
                    <td><input type="text" value="${item.attachment || ''}" onchange="updateRebateField(${item.id}, 'attachment', this.value)" placeholder="é™„ä»¶é“¾æ¥"></td>
                    <td><input type="text" value="${item.note || ''}" onchange="updateRebateField(${item.id}, 'note', this.value)" placeholder="å¤‡æ³¨"></td>
                    <td><input type="text" value="${item.calculationUnit || ''}" onchange="updateRebateField(${item.id}, 'calculationUnit', this.value)" placeholder="é‡çº²"></td>
                    <td><input type="text" class="rebate-amount-input" data-rebate-id="${item.id}" value="${formatAmountDisplay(item.amount)}" placeholder="0.00" required></td>
                    <td><input type="text" value="${item.supplierCode || ''}" onchange="updateRebateField(${item.id}, 'supplierCode', this.value)" placeholder="ç¼–ç " required></td>
                    <td><input type="text" value="${item.department1 || ''}" onchange="updateRebateField(${item.id}, 'department1', this.value)" placeholder="ä¸€çº§éƒ¨é—¨" required></td>
                    <td><input type="text" value="${item.department2 || ''}" onchange="updateRebateField(${item.id}, 'department2', this.value)" placeholder="äºŒçº§éƒ¨é—¨" required></td>
                    <td style="background: #f0f0f0;"><input type="text" value="${item.recommendedVehicles || ''}" readonly style="background: #f0f0f0; cursor: not-allowed;" placeholder="ç³»ç»Ÿç”Ÿæˆ"></td>
                    <td style="background: #f0f0f0;"><input type="text" value="${item.recommendedTime || ''}" readonly style="background: #f0f0f0; cursor: not-allowed;" placeholder="ç³»ç»Ÿç”Ÿæˆ"></td>
                    <td><button class="delete-button" onclick="deleteRebateRow(${item.id})">åˆ é™¤</button></td>
                </tr>`;
            });
            tbody.innerHTML = html;

            // ä¸ºè¿”åˆ©é‡‘é¢è¾“å…¥æ¡†æ·»åŠ æ ¼å¼åŒ–äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.rebate-amount-input').forEach(input => {
                // è·å–ç„¦ç‚¹æ—¶å»é™¤åƒåˆ†ç¬¦ï¼Œä¾¿äºç¼–è¾‘
                input.addEventListener('focus', function() {
                    if (this.value) {
                        this.value = this.value.replace(/,/g, '');
                    }
                });

                // å¤±å»ç„¦ç‚¹æ—¶æ ¼å¼åŒ–ä¸ºåƒåˆ†ç¬¦+ä¸¤ä½å°æ•°
                input.addEventListener('blur', function() {
                    const rebateId = parseInt(this.dataset.rebateId);
                    const rawValue = this.value.replace(/,/g, '');

                    if (rawValue) {
                        const num = parseFloat(rawValue);
                        if (!isNaN(num)) {
                            this.value = num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                            updateRebateField(rebateId, 'amount', num);
                        }
                    } else {
                        updateRebateField(rebateId, 'amount', '');
                    }
                });
            });
        }

        // æ›´æ–°è¿”åˆ©å­—æ®µ
        function updateRebateField(id, field, value) {
            const item = rebateData.find(r => r.id === id);
            if (item) {
                item[field] = value;
                saveRebateData();
                if (field === 'amount') {
                    updateSummary();
                }
            }
        }

        // ä¸‹è½½è¿”åˆ©è®°å½•æ¨¡æ¿
        function downloadRebateTemplate() {
            // åˆ›å»ºè¡¨å¤´ï¼ˆä¸åŒ…å«ç³»ç»Ÿç”Ÿæˆçš„å­—æ®µï¼‰
            const headers = ['ææŠ¥æ—¥æœŸ', 'é‡‡è´­ç»ç†*', 'è¿”åˆ©ç±»å‹*', 'è¿”åˆ©å•ä»·', 'å•ä»·è¿”åˆ©è½¦å‹', 'é›¶ä»¶/SORåŒ…', 'ä¾›åº”å•†åç§°*', 'ä¾›åº”å•†ä¾›è´§è½¦å‹*', 'ä¸šåŠ¡å‘ç”Ÿæ—¶é—´èµ·ç‚¹', 'ä¸šåŠ¡å‘ç”Ÿæ—¶é—´ç»ˆç‚¹', 'å…¬å‡½/åè®®æœ€æ—©ç­¾ç½²æ—¶é—´*', 'å…¬å‡½/åè®®æœ€è¿Ÿç­¾ç½²æ—¶é—´*', 'é™„ä»¶', 'å¤‡æ³¨', 'è¿”åˆ©è®¡ç®—é‡çº²', 'è¿”åˆ©é‡‘é¢*', 'ä¾›åº”å•†ç¼–ç *', 'é‡‡è´­-ä¸€çº§éƒ¨é—¨*', 'é‡‡è´­-äºŒçº§éƒ¨é—¨*'];

            // æ·»åŠ ç¤ºä¾‹æ•°æ®è¡Œ
            const data = [
                headers,
                ['2026-01-15', 'å¼ ä¸‰', 'ä¸€èˆ¬ä¸€æ¬¡æ€§è¿”åˆ©', 1000, 'X01', '', 'ä¾›åº”å•†A', 'X01,X02', '2026-01-01', '2026-03-31', '2026.Q1', '2026.Q2', '', 'ç¤ºä¾‹å¤‡æ³¨1', '', 100000, 'SUP001', 'é‡‡è´­éƒ¨', 'é‡‡è´­ä¸€ç§‘'],
                ['2026-02-20', 'æå››', 'é˜¶æ¢¯è¿”åˆ©', 2000, 'X01,X02', 'é›¶ä»¶åŒ…A', 'ä¾›åº”å•†B', 'X01,X02,X03', '2026-02-01', '2026-06-30', '2026.Q2', '2026.Q3', 'http://example.com/file.pdf', 'ç¤ºä¾‹å¤‡æ³¨2', 'å°', 200000, 'SUP002', 'é‡‡è´­éƒ¨', 'é‡‡è´­äºŒç§‘'],
                ['', 'ç‹äº”', 'å¹´åº¦è¿”åˆ©', '', '', 'SORåŒ…B', 'ä¾›åº”å•†C', 'X01,X02,X03,X04', '', '', '2026.Q1', '2026.Q4', '', 'å¤šè½¦å‹ç¤ºä¾‹', 'ä»¶', 150000, 'SUP003', 'é‡‡è´­éƒ¨', 'é‡‡è´­ä¸‰ç§‘']
            ];

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(data);

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è¿”åˆ©è®°å½•');

            // ä¸‹è½½Excelæ–‡ä»¶
            XLSX.writeFile(wb, 'è¿”åˆ©è®°å½•æ¨¡æ¿.xlsx');
        }

        // å¯¼å‡ºè¿”åˆ©æ•°æ®
        function exportRebateData() {
            if (rebateData.length === 0) {
                alert('æš‚æ— è¿”åˆ©æ•°æ®å¯å¯¼å‡º');
                return;
            }

            // è¡¨å¤´ï¼ˆåŒ…å«æ‰€æœ‰21ä¸ªå­—æ®µ+2ä¸ªç³»ç»Ÿç”Ÿæˆå­—æ®µï¼‰
            const headers = ['ææŠ¥æ—¥æœŸ', 'é‡‡è´­ç»ç†*', 'è¿”åˆ©ç±»å‹*', 'è¿”åˆ©å•ä»·', 'å•ä»·è¿”åˆ©è½¦å‹', 'é›¶ä»¶/SORåŒ…', 'ä¾›åº”å•†åç§°*', 'ä¾›åº”å•†ä¾›è´§è½¦å‹*', 'ä¸šåŠ¡å‘ç”Ÿæ—¶é—´èµ·ç‚¹', 'ä¸šåŠ¡å‘ç”Ÿæ—¶é—´ç»ˆç‚¹', 'å…¬å‡½/åè®®æœ€æ—©ç­¾ç½²æ—¶é—´*', 'å…¬å‡½/åè®®æœ€è¿Ÿç­¾ç½²æ—¶é—´*', 'é™„ä»¶', 'å¤‡æ³¨', 'è¿”åˆ©è®¡ç®—é‡çº²', 'è¿”åˆ©é‡‘é¢*', 'ä¾›åº”å•†ç¼–ç *', 'é‡‡è´­-ä¸€çº§éƒ¨é—¨*', 'é‡‡è´­-äºŒçº§éƒ¨é—¨*', 'æ¨èè½åœ°è½¦å‹', 'æ¨èè½åœ°æ—¶é—´'];

            // å‡†å¤‡æ•°æ®
            const data = [headers];

            rebateData.forEach(item => {
                data.push([
                    item.submitDate || '',
                    item.manager || '',
                    item.type || '',
                    item.unitPrice || '',
                    item.unitPriceVehicles || '',
                    item.partsSOR || '',
                    item.supplier || '',
                    item.vehicles || '',
                    item.businessStartTime || '',
                    item.businessEndTime || '',
                    item.earliestSignQuarter || '',
                    item.latestSignQuarter || '',
                    item.attachment || '',
                    item.note || '',
                    item.calculationUnit || '',
                    item.amount || '',
                    item.supplierCode || '',
                    item.department1 || '',
                    item.department2 || '',
                    item.recommendedVehicles || '',
                    item.recommendedTime || ''
                ]);
            });

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(data);

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è¿”åˆ©æ•°æ®');

            // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
            const now = new Date();
            const timestamp = now.getFullYear() +
                              String(now.getMonth() + 1).padStart(2, '0') +
                              String(now.getDate()).padStart(2, '0') + '_' +
                              String(now.getHours()).padStart(2, '0') +
                              String(now.getMinutes()).padStart(2, '0');

            // ä¸‹è½½Excelæ–‡ä»¶
            XLSX.writeFile(wb, `è¿”åˆ©æ•°æ®_${timestamp}.xlsx`);
        }

        // å¯¼å…¥è¿”åˆ©è®°å½•æ•°æ®
        function importRebateData(event) {
            console.log('=== è¿”åˆ©å¯¼å…¥å‡½æ•°è¢«è°ƒç”¨ ===');

            const file = event.target.files[0];
            console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);

            if (!file) {
                console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }

            console.log('æ–‡ä»¶å:', file.name, 'æ–‡ä»¶å¤§å°:', file.size, 'å­—èŠ‚');

            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('=== æ–‡ä»¶è¯»å–å®Œæˆ ===');
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSONæ ¼å¼
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    processRebateData(jsonData);
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                }
            };
            reader.readAsArrayBuffer(file);

            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // å¤„ç†è¿”åˆ©è®°å½•æ•°æ®
        function processRebateData(jsonData) {
            console.log('è¿”åˆ©Excelæ•°æ®:', jsonData);

            if (!jsonData || jsonData.length === 0) {
                alert('æ–‡ä»¶ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼');
                return;
            }

            // è·³è¿‡è¡¨å¤´ï¼ˆç¬¬ä¸€è¡Œï¼‰
            let startIndex = 0;
            const firstRow = jsonData[0];
            if (firstRow && (firstRow[0] === 'ææŠ¥æ—¥æœŸ' || String(firstRow[1]).includes('é‡‡è´­ç»ç†') || String(firstRow[2]).includes('è¿”åˆ©ç±»å‹'))) {
                startIndex = 1;
                console.log('æ£€æµ‹åˆ°è¿”åˆ©è¡¨å¤´:', firstRow);
            }

            let importCount = 0;
            let errorLines = [];

            for (let i = startIndex; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                console.log(`è¿”åˆ©ç¬¬${i+1}è¡Œæ•°æ®:`, row);

                // å­—æ®µé¡ºåºï¼šææŠ¥æ—¥æœŸ,é‡‡è´­ç»ç†*,è¿”åˆ©ç±»å‹*,è¿”åˆ©å•ä»·,å•ä»·è¿”åˆ©è½¦å‹,é›¶ä»¶/SORåŒ…,ä¾›åº”å•†åç§°*,ä¾›åº”å•†ä¾›è´§è½¦å‹*,ä¸šåŠ¡å‘ç”Ÿæ—¶é—´èµ·ç‚¹,ä¸šåŠ¡å‘ç”Ÿæ—¶é—´ç»ˆç‚¹,å…¬å‡½/åè®®æœ€æ—©ç­¾ç½²æ—¶é—´*,å…¬å‡½/åè®®æœ€è¿Ÿç­¾ç½²æ—¶é—´*,é™„ä»¶,å¤‡æ³¨,è¿”åˆ©è®¡ç®—é‡çº²,è¿”åˆ©é‡‘é¢*,ä¾›åº”å•†ç¼–ç *,é‡‡è´­-ä¸€çº§éƒ¨é—¨*,é‡‡è´­-äºŒçº§éƒ¨é—¨*
                if (row.length < 2) {
                    errorLines.push(`ç¬¬${i+1}è¡Œï¼šå­—æ®µæ•°ä¸è¶³`);
                    continue;
                }

                // å¤„ç†æ—¥æœŸå­—æ®µï¼ˆExcelå¯èƒ½è¿”å›åºåˆ—å·ï¼‰
                const submitDate = row[0] ? (typeof row[0] === 'number' ? XLSX.SSF.format('yyyy-mm-dd', row[0]) : String(row[0])) : '';
                const businessStartTime = row[8] ? (typeof row[8] === 'number' ? XLSX.SSF.format('yyyy-mm-dd', row[8]) : String(row[8])) : '';
                const businessEndTime = row[9] ? (typeof row[9] === 'number' ? XLSX.SSF.format('yyyy-mm-dd', row[9]) : String(row[9])) : '';

                // åˆ›å»ºæ–°çš„è¿”åˆ©è®°å½•
                rebateData.push({
                    id: rebateIdCounter++,
                    submitDate: submitDate,
                    manager: row[1] ? String(row[1]) : '',
                    type: row[2] ? String(row[2]) : '',
                    unitPrice: row[3] ? String(row[3]) : '',
                    unitPriceVehicles: row[4] ? String(row[4]) : '',
                    partsSOR: row[5] ? String(row[5]) : '',
                    supplier: row[6] ? String(row[6]) : '',
                    vehicles: row[7] ? String(row[7]) : '',
                    businessStartTime: businessStartTime,
                    businessEndTime: businessEndTime,
                    earliestSignQuarter: row[10] ? String(row[10]) : '',
                    latestSignQuarter: row[11] ? String(row[11]) : '',
                    attachment: row[12] ? String(row[12]) : '',
                    note: row[13] ? String(row[13]) : '',
                    calculationUnit: row[14] ? String(row[14]) : '',
                    amount: row[15] ? String(row[15]) : '',
                    supplierCode: row[16] ? String(row[16]) : '',
                    department1: row[17] ? String(row[17]) : '',
                    department2: row[18] ? String(row[18]) : '',
                    recommendedVehicles: '', // ç³»ç»Ÿç”Ÿæˆï¼Œå¯¼å…¥æ—¶ç•™ç©º
                    recommendedTime: '' // ç³»ç»Ÿç”Ÿæˆï¼Œå¯¼å…¥æ—¶ç•™ç©º
                });

                importCount++;
            }

            console.log('=== å¯¼å…¥å®Œæˆï¼Œæ€»å…±å¯¼å…¥:', importCount, 'æ¡ ===');

            renderRebateTable();
            saveRebateData();
            updateSummary();

            let message = `æˆåŠŸå¯¼å…¥ ${importCount} æ¡è¿”åˆ©è®°å½•ï¼`;
            if (errorLines.length > 0 && errorLines.length < 10) {
                message += '\n\nè·³è¿‡çš„è¡Œï¼š\n' + errorLines.join('\n');
            } else if (errorLines.length >= 10) {
                message += `\n\nè·³è¿‡äº† ${errorLines.length} è¡Œï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…`;
                console.log('è·³è¿‡çš„è¡Œ:', errorLines);
            }
            alert(message);
        }

        // è§£æCSVè¡Œï¼ˆå¤„ç†å¸¦å¼•å·çš„å­—æ®µï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            // æ·»åŠ æœ€åä¸€ä¸ªå­—æ®µ
            result.push(current.trim());

            return result;
        }

        // ===== è¿”åˆ©åˆ†é…ç®—æ³• =====

        // è§£æå­£åº¦å­—ç¬¦ä¸² (e.g., "2026.Q1" â†’ "Q1")
        function parseQuarter(quarterStr) {
            if (!quarterStr) return null;
            const match = quarterStr.match(/Q[1-4]/i);
            return match ? match[0].toUpperCase() : null;
        }

        // è·å–ä¸¤ä¸ªå­£åº¦ä¹‹é—´çš„æ‰€æœ‰å­£åº¦
        function getQuarterRange(startQ, endQ) {
            if (!startQ || !endQ) return [];
            const startIdx = quarters.indexOf(startQ);
            const endIdx = quarters.indexOf(endQ);
            if (startIdx === -1 || endIdx === -1) return [];

            const result = [];
            for (let i = startIdx; i <= endIdx; i++) {
                result.push(quarters[i]);
            }
            return result;
        }

        // æ‰§è¡Œæ™ºèƒ½åˆ†é…ï¼ˆæ–°ç®—æ³•ï¼šä¸æ‹†åˆ†è¿”åˆ©ï¼‰
        function performAllocation() {
            // 1. æ”¶é›†æ‰€æœ‰ç¼ºå£æ•°æ®ï¼Œåˆ›å»ºå‰©ä½™ç¼ºå£å‰¯æœ¬
            const remainingGaps = {};
            vehicles.forEach(vehicle => {
                remainingGaps[vehicle.code] = {};
                quarters.forEach(quarter => {
                    const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                    const gapAmount = input && input.value ? parseFloat(input.value) : 0;
                    remainingGaps[vehicle.code][quarter] = gapAmount;
                });
            });

            // 2. ç”¨äºè®°å½•åˆ†é…ç»“æœ
            const allocationResults = {};
            vehicles.forEach(vehicle => {
                allocationResults[vehicle.code] = {};
                quarters.forEach(quarter => {
                    const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                    const gapAmount = input && input.value ? parseFloat(input.value) : 0;
                    allocationResults[vehicle.code][quarter] = {
                        original: gapAmount,
                        allocated: 0,
                        sources: []
                    };
                });
            });

            // 3. éå†è¿”åˆ©è®°å½•ï¼ŒæŒ‰é¡ºåºåˆ†é…
            rebateData.forEach(rebate => {
                if (!rebate.amount || !rebate.vehicles) {
                    // å¦‚æœæ²¡æœ‰é‡‘é¢æˆ–è½¦å‹ï¼Œæ ‡è®°ä¸ºæœªåˆ†é…
                    rebate.recommendedVehicles = '';
                    rebate.recommendedTime = '';
                    return;
                }

                const rebateAmount = parseFloat(rebate.amount);
                if (rebateAmount <= 0) {
                    rebate.recommendedVehicles = '';
                    rebate.recommendedTime = '';
                    return;
                }

                // è§£æå¯åˆ†é…è½¦å‹ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰
                const rebateVehicles = rebate.vehicles
                    .split(',')
                    .map(v => v.trim())
                    .filter(v => v);

                if (rebateVehicles.length === 0) {
                    rebate.recommendedVehicles = '';
                    rebate.recommendedTime = '';
                    return;
                }

                // è§£æç­¾ç½²æ—¶é—´èŒƒå›´
                const startQ = parseQuarter(rebate.earliestSignQuarter);
                const endQ = parseQuarter(rebate.latestSignQuarter);
                let applicableQuarters = [];

                if (startQ && endQ) {
                    applicableQuarters = getQuarterRange(startQ, endQ);
                } else if (startQ) {
                    applicableQuarters = [startQ];
                } else if (endQ) {
                    applicableQuarters = [endQ];
                } else {
                    // å¦‚æœæ²¡æœ‰æŒ‡å®šæ—¶é—´ï¼Œé»˜è®¤é€‚ç”¨æ‰€æœ‰å­£åº¦
                    applicableQuarters = [...quarters];
                }

                // 4. æŒ‰å­£åº¦ä¼˜å…ˆçº§ï¼ˆQ1>Q2>Q3>Q4ï¼‰å°è¯•åˆ†é…
                let allocated = false;
                for (const quarter of applicableQuarters) {
                    if (allocated) break;

                    // åœ¨å½“å‰å­£åº¦å†…ï¼Œæ‰¾å‡ºæ‰€æœ‰å¯åˆ†é…è½¦å‹ä¸­æœ‰å‰©ä½™ç¼ºå£çš„è½¦å‹
                    const candidateVehicles = [];
                    rebateVehicles.forEach(vehicleCode => {
                        if (remainingGaps[vehicleCode] && remainingGaps[vehicleCode][quarter] > 0) {
                            candidateVehicles.push({
                                code: vehicleCode,
                                gap: remainingGaps[vehicleCode][quarter]
                            });
                        }
                    });

                    if (candidateVehicles.length === 0) continue;

                    // é€‰æ‹©ç¼ºå£æœ€å¤§çš„è½¦å‹ï¼ˆå‡è¡¡ç­–ç•¥ï¼‰
                    candidateVehicles.sort((a, b) => b.gap - a.gap);
                    const selectedVehicle = candidateVehicles[0];

                    // æ£€æŸ¥è¯¥ç¼ºå£æ˜¯å¦>=è¿”åˆ©é‡‘é¢
                    if (selectedVehicle.gap >= rebateAmount) {
                        // å¯ä»¥å®Œæ•´åˆ†é…
                        remainingGaps[selectedVehicle.code][quarter] -= rebateAmount;
                        allocationResults[selectedVehicle.code][quarter].allocated += rebateAmount;
                        allocationResults[selectedVehicle.code][quarter].sources.push({
                            rebateId: rebate.id,
                            supplier: rebate.supplier || 'æœªçŸ¥',
                            amount: rebateAmount
                        });

                        // æ›´æ–°æ¨èè½åœ°è½¦å‹å’Œæ—¶é—´
                        rebate.recommendedVehicles = selectedVehicle.code;
                        rebate.recommendedTime = `2026.${quarter}`;
                        allocated = true;
                    } else if (selectedVehicle.gap > 0) {
                        // ç¼ºå£ä¸è¶³ï¼Œä½†ä»ç„¶åˆ†é…ï¼ˆéƒ¨åˆ†å¡«å……ï¼‰
                        remainingGaps[selectedVehicle.code][quarter] = 0;
                        allocationResults[selectedVehicle.code][quarter].allocated += rebateAmount;
                        allocationResults[selectedVehicle.code][quarter].sources.push({
                            rebateId: rebate.id,
                            supplier: rebate.supplier || 'æœªçŸ¥',
                            amount: rebateAmount
                        });

                        rebate.recommendedVehicles = selectedVehicle.code;
                        rebate.recommendedTime = `2026.${quarter}`;
                        allocated = true;
                    }
                }

                // å¦‚æœæ²¡æœ‰åˆ†é…æˆåŠŸï¼ˆæ²¡æœ‰åŒ¹é…çš„ç¼ºå£ï¼‰ï¼Œæ ‡è®°ä¸ºæœªåˆ†é…
                if (!allocated) {
                    rebate.recommendedVehicles = 'æ— åŒ¹é…ç¼ºå£';
                    rebate.recommendedTime = '-';
                }
            });

            // ä¿å­˜æ›´æ–°åçš„è¿”åˆ©æ•°æ®ï¼ˆåŒ…å«æ¨èè½åœ°è½¦å‹å’Œæ—¶é—´ï¼‰
            saveRebateData();
            renderRebateTable();

            return allocationResults;
        }

        // æ¸²æŸ“åˆ†é…ç»“æœè¡¨æ ¼
        function renderAllocationTable() {
            const allocationResults = performAllocation();
            const tbody = document.getElementById('allocationTableBody');

            let html = '';
            vehicles.forEach(vehicle => {
                html += `<tr><td class="vehicle-label">${vehicle.icon} ${vehicle.name}</td>`;

                quarters.forEach(quarter => {
                    const data = allocationResults[vehicle.code][quarter];
                    const remaining = data.original - data.allocated;
                    const fillRate = data.original > 0 ? (data.allocated / data.original * 100).toFixed(1) : 0;

                    // æ ¹æ®å¡«å……æƒ…å†µè®¾ç½®èƒŒæ™¯è‰²
                    let bgColor = '#fff5f8'; // é»˜è®¤æµ…ç²‰è‰²
                    if (fillRate >= 100) {
                        bgColor = '#d4edda'; // ç»¿è‰² - å®Œå…¨å¡«å……
                    } else if (fillRate > 50) {
                        bgColor = '#fff3cd'; // é»„è‰² - å¡«å……è¶…è¿‡50%
                    } else if (fillRate > 0 && fillRate < 20) {
                        bgColor = '#ffe4e1'; // æµ…çº¢ - å¡«å……å°äº20%
                    }

                    html += `<td style="background: ${bgColor}; padding: 8px 10px; font-size: 0.9em;">
                        <div style="line-height: 1.6;"><strong>åŸå§‹:</strong> Â¥${formatCurrency(data.original)}</div>
                        <div style="color: #28a745; line-height: 1.6;"><strong>åˆ†é…:</strong> Â¥${formatCurrency(data.allocated)}</div>
                        <div style="color: ${remaining > 0 ? '#dc3545' : '#28a745'}; line-height: 1.6;"><strong>å‰©ä½™:</strong> Â¥${formatCurrency(remaining)}</div>
                    </td>`;
                });

                // è®¡ç®—è¯¥è½¦å‹æ€»è®¡
                let vehicleOriginal = 0, vehicleAllocated = 0;
                quarters.forEach(q => {
                    vehicleOriginal += allocationResults[vehicle.code][q].original;
                    vehicleAllocated += allocationResults[vehicle.code][q].allocated;
                });
                const vehicleRemaining = vehicleOriginal - vehicleAllocated;

                html += `<td class="total-cell" style="font-size: 0.9em; padding: 8px 10px;">
                    <div style="line-height: 1.6;">åŸå§‹: Â¥${formatCurrency(vehicleOriginal)}</div>
                    <div style="color: #28a745; line-height: 1.6;">åˆ†é…: Â¥${formatCurrency(vehicleAllocated)}</div>
                    <div style="color: ${vehicleRemaining > 0 ? '#dc3545' : '#28a745'}; line-height: 1.6;">å‰©ä½™: Â¥${formatCurrency(vehicleRemaining)}</div>
                </td></tr>`;
            });

            tbody.innerHTML = html;
        }

        // ===== ç»Ÿè®¡æ±‡æ€» =====
        function updateSummary() {
            // è®¡ç®—æ€»æŒ‡æ ‡ç¼ºå£
            let totalGap = 0;
            vehicles.forEach(vehicle => {
                quarters.forEach(quarter => {
                    const input = document.querySelector(`#gapTable [data-vehicle="${vehicle.code}"][data-quarter="${quarter}"]`);
                    if (input && input.value) {
                        // å»é™¤åƒåˆ†ç¬¦åå†è§£æ
                        totalGap += parseFloat(input.value.replace(/,/g, ''));
                    }
                });
            });

            // è®¡ç®—æ€»è¿”åˆ©é‡‘é¢
            let totalRebate = 0;
            rebateData.forEach(item => {
                if (item.amount) {
                    // item.amountå­˜å‚¨çš„æ˜¯åŸå§‹æ•°å€¼ï¼Œä¸éœ€è¦å»é™¤åƒåˆ†ç¬¦
                    totalRebate += parseFloat(item.amount);
                }
            });

            // è®¡ç®—å‰©ä½™ç¼ºå£
            const remaining = totalGap - totalRebate;

            // è®¡ç®—å¡«å……ç‡
            const fillRate = totalGap > 0 ? ((totalRebate / totalGap) * 100).toFixed(1) : 0;

            document.getElementById('totalGap').textContent = `Â¥${formatCurrency(totalGap)}`;
            document.getElementById('totalRebate').textContent = `Â¥${formatCurrency(totalRebate)}`;
            document.getElementById('remainingGap').textContent = `Â¥${formatCurrency(remaining)}`;
            document.getElementById('fillRate').textContent = `${fillRate}%`;
        }

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            generateGapTable();
            loadGapData();
            loadRebateData();
            updateSummary();
        });
    </script>
</body>
</html>